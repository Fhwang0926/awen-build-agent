name: Build Test

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop
      - deploy
      - 'dev/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  check-changes:
    name: Check Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      is-deploy-pr: ${{ steps.check-deploy.outputs.is-deploy-pr }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if PR to deploy branch
        id: check-deploy
        if: github.event_name == 'pull_request'
        run: |
          if [ "${{ github.base_ref }}" = "deploy" ]; then
            echo "is-deploy-pr=true" >> $GITHUB_OUTPUT
          else
            echo "is-deploy-pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Check Changed Files
        id: filter
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PR, use merge-base
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            HEAD_REF="${{ github.event.pull_request.head.ref }}"
            
            git fetch origin ${BASE_REF}:${BASE_REF} || true
            git fetch origin ${HEAD_REF}:${HEAD_REF} || true
            
            BASE_SHA=$(git merge-base origin/${BASE_REF} origin/${HEAD_REF} 2>/dev/null || echo "${{ github.event.pull_request.base.sha }}")
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            
            echo "PR: Base ref: ${BASE_REF}, Head ref: ${HEAD_REF}"
            echo "PR: Base SHA: ${BASE_SHA}, Head SHA: ${HEAD_SHA}"
            
            if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" = "null" ]; then
              BASE_SHA="origin/${BASE_REF}"
            fi
            if [ -z "$HEAD_SHA" ] || [ "$HEAD_SHA" = "null" ]; then
              HEAD_SHA="origin/${HEAD_REF}"
            fi
          else
            # For push events
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
            
            echo "Push: Base SHA: ${BASE_SHA}, Head SHA: ${HEAD_SHA}"
            
            if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
              if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
                BASE_SHA="HEAD~1"
              else
                BASE_SHA="4b825dc642cb6eb9a060e54bf8d69288fbee4904"
              fi
            fi
          fi
          
          # Get changed files
          CHANGED_FILES=$(git diff --name-only ${BASE_SHA}..${HEAD_SHA} 2>/dev/null || echo "")
          
          if [ -z "$CHANGED_FILES" ] && [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/${BASE_REF}...${HEAD_SHA} 2>/dev/null || echo "")
          fi
          
          # Check for backend changes
          if [ -n "$CHANGED_FILES" ]; then
            BACKEND_MATCHES=$(echo "$CHANGED_FILES" | grep -E '(\.(js|json)$|^task/|\.github/workflows/)' || true)
            
            if [ -n "$BACKEND_MATCHES" ]; then
              BACKEND_COUNT=$(echo "$BACKEND_MATCHES" | wc -l | xargs)
            else
              BACKEND_COUNT=0
            fi
          else
            BACKEND_COUNT=0
          fi
          
          BACKEND_COUNT=$(echo "$BACKEND_COUNT" | xargs)
          BACKEND_COUNT=${BACKEND_COUNT:-0}
          
          echo "Changed files count - Backend: $BACKEND_COUNT"
          echo "Changed files:"
          echo "$CHANGED_FILES" | head -20
          
          # Set outputs
          if [ "$BACKEND_COUNT" != "0" ]; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi

  build-test:
    name: Build Test
    needs: check-changes
    # PRì¸ ê²½ìš° í•­ìƒ ì‹¤í–‰ (íŠ¹ížˆ deploy ë¸Œëžœì¹˜ë¡œì˜ PRì€ í•­ìƒ ì „ì²´ í…ŒìŠ¤íŠ¸)
    # Pushì¸ ê²½ìš° ë³€ê²½ì‚¬í•­ì´ ìžˆì„ ë•Œë§Œ ì‹¤í–‰
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'push' && needs.check-changes.outputs.backend == 'true')
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build Test - Install Dependencies
        if: |
          needs.check-changes.outputs.is-deploy-pr == 'true' ||
          needs.check-changes.outputs.backend == 'true' ||
          github.event_name == 'pull_request'
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci
          echo "âœ… Dependencies installed"

      - name: Set up Node.js 20
        if: |
          needs.check-changes.outputs.is-deploy-pr == 'true' ||
          needs.check-changes.outputs.backend == 'true' ||
          github.event_name == 'pull_request'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build Test - Verify Execution (Node.js 20)
        if: |
          needs.check-changes.outputs.is-deploy-pr == 'true' ||
          needs.check-changes.outputs.backend == 'true' ||
          github.event_name == 'pull_request'
        run: |
          echo "ðŸ§ª Testing with Node.js 20..."
          
          # Test main modules load without errors
          node -e "
            try {
              console.log('Testing AnalyzerAgent...');
              require('./AnalyzerAgent');
              
              console.log('Testing BuilderAgent...');
              require('./BuilderAgent');
              
              console.log('Testing DebuggerAgent...');
              require('./DebuggerAgent');
              
              console.log('Testing DeployAgent...');
              require('./DeployAgent');
              
              console.log('Testing LLMService...');
              require('./LLMService');
              
              console.log('Testing API...');
              require('./api');
              
              console.log('Testing Server...');
              require('./server');
              
              console.log('âœ… All modules load successfully without errors (Node.js 20)');
              process.exit(0);
            } catch (error) {
              console.error('âŒ Execution error detected (Node.js 20):');
              console.error('  ', error.message);
              console.error('  at', error.stack.split('\\n')[1]?.trim());
              process.exit(1);
            }
          "
          
          echo "âœ… Build test passed with Node.js 20"

      - name: Set up Node.js 22
        if: |
          needs.check-changes.outputs.is-deploy-pr == 'true' ||
          needs.check-changes.outputs.backend == 'true' ||
          github.event_name == 'pull_request'
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Build Test - Verify Execution (Node.js 22)
        if: |
          needs.check-changes.outputs.is-deploy-pr == 'true' ||
          needs.check-changes.outputs.backend == 'true' ||
          github.event_name == 'pull_request'
        run: |
          echo "ðŸ§ª Testing with Node.js 22..."
          
          # Test main modules load without errors
          node -e "
            try {
              console.log('Testing AnalyzerAgent...');
              require('./AnalyzerAgent');
              
              console.log('Testing BuilderAgent...');
              require('./BuilderAgent');
              
              console.log('Testing DebuggerAgent...');
              require('./DebuggerAgent');
              
              console.log('Testing DeployAgent...');
              require('./DeployAgent');
              
              console.log('Testing LLMService...');
              require('./LLMService');
              
              console.log('Testing API...');
              require('./api');
              
              console.log('Testing Server...');
              require('./server');
              
              console.log('âœ… All modules load successfully without errors (Node.js 22)');
              process.exit(0);
            } catch (error) {
              console.error('âŒ Execution error detected (Node.js 22):');
              console.error('  ', error.message);
              console.error('  at', error.stack.split('\\n')[1]?.trim());
              process.exit(1);
            }
          "
          
          echo "âœ… Build test passed with Node.js 22"

      - name: Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Build Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js: 20, 22" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒíƒœ: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **ëª¨ë“  ëª¨ë“ˆì´ ì—ëŸ¬ ì—†ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ì‹¤í–‰ ì—ëŸ¬ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤**" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.check-changes.outputs.is-deploy-pr }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **Deploy PR**: ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ë¨" >> $GITHUB_STEP_SUMMARY
          fi

  update-pr-description:
    name: Update PR Description
    if: github.event_name == 'pull_request'
    needs: [check-changes]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR Information
        id: pr-info
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"
          
          echo "PR_NUMBER=pr_${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "BASE_BRANCH=$BASE_BRANCH" >> $GITHUB_OUTPUT
          echo "HEAD_BRANCH=$HEAD_BRANCH" >> $GITHUB_OUTPUT

      - name: Get Changed Files
        id: changed-files
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          git fetch origin ${BASE_REF}:${BASE_REF} || true
          git fetch origin ${HEAD_REF}:${HEAD_REF} || true
          MERGE_BASE=$(git merge-base origin/${BASE_REF} origin/${HEAD_REF} 2>/dev/null || echo "${{ github.event.pull_request.base.sha }}")
          
          CHANGED_FILES=$(git diff --name-only ${MERGE_BASE}..${HEAD_SHA} 2>/dev/null || echo "")
          
          BACKEND_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(js|json)$' || echo "")
          TASK_FILES=$(echo "$CHANGED_FILES" | grep '^task/' || echo "")
          CONFIG_FILES=$(echo "$CHANGED_FILES" | grep -E '(\.yml$|\.yaml$|\.md$|\.env)' || echo "")
          
          # Count files safely
          BACKEND_COUNT=$(echo "$BACKEND_FILES" | grep -v '^$' | wc -l | xargs)
          TASK_COUNT=$(echo "$TASK_FILES" | grep -v '^$' | wc -l | xargs)
          CONFIG_COUNT=$(echo "$CONFIG_FILES" | grep -v '^$' | wc -l | xargs)
          TOTAL_COUNT=$(echo "$CHANGED_FILES" | grep -v '^$' | wc -l | xargs)
          
          # Set outputs with string prefix
          echo "BACKEND_COUNT=count_${BACKEND_COUNT:-0}" >> $GITHUB_OUTPUT
          echo "TASK_COUNT=count_${TASK_COUNT:-0}" >> $GITHUB_OUTPUT
          echo "CONFIG_COUNT=count_${CONFIG_COUNT:-0}" >> $GITHUB_OUTPUT
          echo "TOTAL_COUNT=count_${TOTAL_COUNT:-0}" >> $GITHUB_OUTPUT
          
          echo "BACKEND_FILES<<EOF" >> $GITHUB_OUTPUT
          echo "$BACKEND_FILES" | head -20 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "TASK_FILES<<EOF" >> $GITHUB_OUTPUT
          echo "$TASK_FILES" | head -20 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "CONFIG_FILES<<EOF" >> $GITHUB_OUTPUT
          echo "$CONFIG_FILES" | head -20 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get Commits
        id: commits
        run: |
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          git fetch origin ${BASE_REF}:${BASE_REF} || true
          git fetch origin ${HEAD_REF}:${HEAD_REF} || true
          
          MERGE_BASE=$(git merge-base origin/${BASE_REF} origin/${HEAD_REF} 2>/dev/null || echo "origin/${BASE_REF}")
          
          COMMITS=$(git log ${MERGE_BASE}..${HEAD_SHA} --pretty=format:"- %s (%h)" 2>/dev/null || echo "")
          COMMIT_COUNT=$(git rev-list --count ${MERGE_BASE}..${HEAD_SHA} 2>/dev/null || echo "0")
          
          COMMIT_COUNT=$(echo "$COMMIT_COUNT" | tr -d '[:space:]')
          COMMIT_COUNT=${COMMIT_COUNT:-0}
          
          echo "COMMIT_COUNT=count_${COMMIT_COUNT}" >> $GITHUB_OUTPUT
          echo "COMMITS<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate PR Description
        id: pr-description
        run: |
          BASE_BRANCH="${{ steps.pr-info.outputs.BASE_BRANCH }}"
          HEAD_BRANCH="${{ steps.pr-info.outputs.HEAD_BRANCH }}"
          
          COMMIT_COUNT="${{ steps.commits.outputs.COMMIT_COUNT }}"
          COMMIT_COUNT="${COMMIT_COUNT#count_}"
          
          BACKEND_COUNT="${{ steps.changed-files.outputs.BACKEND_COUNT }}"
          BACKEND_COUNT="${BACKEND_COUNT#count_}"
          
          TASK_COUNT="${{ steps.changed-files.outputs.TASK_COUNT }}"
          TASK_COUNT="${TASK_COUNT#count_}"
          
          CONFIG_COUNT="${{ steps.changed-files.outputs.CONFIG_COUNT }}"
          CONFIG_COUNT="${CONFIG_COUNT#count_}"
          
          TOTAL_COUNT="${{ steps.changed-files.outputs.TOTAL_COUNT }}"
          TOTAL_COUNT="${TOTAL_COUNT#count_}"
          
          COMMITS="${{ steps.commits.outputs.COMMITS }}"
          
          {
            echo "## ðŸ“‹ ë³€ê²½ì‚¬í•­ ìš”ì•½"
            echo ""
            echo "**ë¸Œëžœì¹˜**: \`${HEAD_BRANCH}\` â†’ \`${BASE_BRANCH}\`"
            echo "**ì»¤ë°‹ ìˆ˜**: ${COMMIT_COUNT}ê°œ"
            echo "**ë³€ê²½ëœ íŒŒì¼**: ${TOTAL_COUNT}ê°œ"
            echo ""
            echo "### ðŸ“ ë³€ê²½ëœ íŒŒì¼ ë¶„ë¥˜"
            echo "- **Backend**: ${BACKEND_COUNT}ê°œ"
            echo "- **Task Projects**: ${TASK_COUNT}ê°œ"
            echo "- **ì„¤ì •/ë¬¸ì„œ**: ${CONFIG_COUNT}ê°œ"
            echo ""
            echo "---"
            echo ""
            echo "## ðŸ“ ì»¤ë°‹ ë‚´ì—­"
            echo ""
            if [ -n "$COMMITS" ]; then
              echo "$COMMITS"
            else
              echo "ì»¤ë°‹ì´ ì—†ìŠµë‹ˆë‹¤."
            fi
            echo ""
            echo "---"
            echo ""
            echo "## ðŸ“‚ ì£¼ìš” ë³€ê²½ íŒŒì¼"
          } > pr_description.md
          
          if [ "$BACKEND_COUNT" -gt 0 ]; then
            echo "" >> pr_description.md
            echo "### Backend" >> pr_description.md
            echo "\`\`\`" >> pr_description.md
            echo "${{ steps.changed-files.outputs.BACKEND_FILES }}" >> pr_description.md
            echo "\`\`\`" >> pr_description.md
          fi
          
          if [ "$TASK_COUNT" -gt 0 ]; then
            echo "" >> pr_description.md
            echo "### Task Projects" >> pr_description.md
            echo "\`\`\`" >> pr_description.md
            echo "${{ steps.changed-files.outputs.TASK_FILES }}" >> pr_description.md
            echo "\`\`\`" >> pr_description.md
          fi
          
          if [ "$CONFIG_COUNT" -gt 0 ]; then
            echo "" >> pr_description.md
            echo "### ì„¤ì •/ë¬¸ì„œ" >> pr_description.md
            echo "\`\`\`" >> pr_description.md
            echo "${{ steps.changed-files.outputs.CONFIG_FILES }}" >> pr_description.md
            echo "\`\`\`" >> pr_description.md
          fi
          
          cat >> pr_description.md << 'EOF'
          
          ---
          
          ## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸
          
          - [ ] ì½”ë“œ ë¦¬ë·° ì™„ë£Œ
          - [ ] í…ŒìŠ¤íŠ¸ ì™„ë£Œ
          - [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸ (í•„ìš”í•œ ê²½ìš°)
          - [ ] ë¹Œë“œ í…ŒìŠ¤íŠ¸ í†µê³¼
          EOF

      - name: Update PR Description
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const prNumber = ${{ github.event.pull_request.number }};
            const description = fs.readFileSync('pr_description.md', 'utf8');
            
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            
            if (!pr.body || pr.body.trim().length < 50) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                body: description,
              });
              console.log('âœ… PR description updated automatically');
            } else {
              console.log('â„¹ï¸ PR description already exists, skipping auto-update');
            }

